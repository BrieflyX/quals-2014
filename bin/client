#!/usr/bin/env ruby
$LOAD_PATH << File.join(File.dirname(__FILE__), '..', 'lib')

require 'pp'
require 'socket'
require 'fritas/codec'
s = TCPSocket.new 'localhost', 6908
s.setsockopt(Socket::IPPROTO_TCP, Socket::TCP_NODELAY, true)

c = Fritas::Codec.new s

h = c.expect :Hello
pp h
c.write :Hello, uuid: h.uuid

pp c.expect(:Ready)

c.write :StorePostReq, post: Fritas::Messages::Post.new(
  title: 'bryce post', 
  body: '420', 
  tags: %w{abc def ghi}.map do |e|
    Fritas::Messages::Tag.new tagname: e
  end)
pp 'stored post'
pp(resp = c.expect(:StorePostResp))

c.write :StorePostReq, post: Fritas::Messages::Post.new(
  title: 'cool pist',
  body: '888',
  tags: ['password=asdf', 'abc'].map do |e|
    Fritas::Messages::Tag.new tagname: e
  end)

pp(resp2 = c.expect(:StorePostResp))

c.write :GetPostReq, uuid: resp.uuid
pp c.expect(:GetPostResp)

c.write :ListTagReq
pp c.expect :ListTagResp

c.write :RelatedTagReq, tag: Fritas::Messages::Tag.new(tagname: 'abc')
pp c.expect :RelatedTagResp

c.write :GetPostReq, uuid: resp2.uuid, password: 'asdf'
pp c.expect :GetPostResp

c.write :GetPostReq, uuid: resp2.uuid
pp c.expect :ErrorResp
