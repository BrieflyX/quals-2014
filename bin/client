#!/usr/bin/env ruby
$LOAD_PATH << File.join(File.dirname(__FILE__), '..', 'lib')

require 'pp'
require 'socket'
require 'medianoche/codec'
s = TCPSocket.new 'localhost', 6909
s.setsockopt(Socket::IPPROTO_TCP, Socket::TCP_NODELAY, true)

c = Medianoche::Codec.new s

h = c.expect :Hello
pp h
c.write :Hello, uuid: h.uuid

pp c.expect(:Ready)

c.write :StorePostReq, post: Medianoche::Messages::Post.new(
  title: 'bryce post', 
  body: '420', 
  tags: %w{abc def ghi}.map do |e|
    Medianoche::Messages::Tag.new tagname: e
  end)
pp(resp = c.expect(:StorePostResp))

c.write :StorePostReq, post: Medianoche::Messages::Post.new(
  title: 'cool pist',
  body: '888',
  tags: ['password=asdf', 'abc'].map do |e|
    Medianoche::Messages::Tag.new tagname: e
  end)
pp(resp2 = c.expect(:StorePostResp))

c.write :ListPostReq
pp c.expect :ListPostResp

c.write :ListPostReq, tag: Medianoche::Messages::Tag.new(tagname: 'def')
pp c.expect :ListPostResp

c.write :GetPostReq, uuid: resp.uuid
pp c.expect(:GetPostResp)

c.write :ListTagReq
pp c.expect :ListTagResp

c.write :RelatedTagReq, tag: Medianoche::Messages::Tag.new(tagname: 'abc')
pp c.expect :RelatedTagResp

c.write :GetPostReq, uuid: resp2.uuid, password: 'asdf'
pp c.expect :GetPostResp

c.write :GetPostReq, uuid: resp2.uuid
pp c.expect :ErrorResp
